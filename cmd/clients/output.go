package clients

import (
	"fmt"
	"github.com/ory/hydra/cmd/cli"
	"github.com/ory/hydra/internal/httpclient/models"
	"github.com/ory/x/cmdx"
	"strings"
)

type (
	outputOAuth2Client models.OAuth2Client
	outputOAuth2ClientCollection []*models.OAuth2Client
)

var (
	_ cmdx.OutputEntry = &outputOAuth2Client{}
	_ cmdx.OutputCollection = outputOAuth2ClientCollection{}

	autoGeneratedSecretDescription = fmt.Sprintf("To encrypt auto generated client secrets, use one of \"--%s\", \"--%s\" or \"--%s\" flags.", cli.FlagKeybase, cli.FlagPGPKey, cli.FlagPGPKeyURL)
)

func (c *outputOAuth2Client) Header() []string {
	return []string{
		"CLIENT ID",
		"NAME",
		"RESPONSE TYPES",
		"SCOPE",
		"REDIRECT URIS",
		"GRANT TYPES",
		"TOKEN ENDPOINT AUTH METHOD",
	}
}

func (c *outputOAuth2Client) Fields() []string {
	data := []string{
		c.ClientID,
		c.ClientName,
		cmdx.None,
		c.Scope,
		cmdx.None,
		cmdx.None,
		c.TokenEndpointAuthMethod,
	}

	if len(c.ResponseTypes) > 0 {
		data[2] = strings.Join(c.ResponseTypes, ", ")
	}

	if len(c.RedirectUris) > 0 {
		data[4] = strings.Join(c.RedirectUris, ", ")
	}

	if len(c.GrantTypes) > 0 {
		data[5] = strings.Join(c.GrantTypes, ", ")
	}

	return data
}

func (c *outputOAuth2Client) Interface() interface{} {
	return c
}

func (c outputOAuth2ClientCollection) Header() []string {
	return []string{
		"CLIENT ID",
		"NAME",
		"RESPONSE TYPE 1",
		"SCOPE",
		"REDIRECT URI 1",
		"GRANT TYPE 1",
		"TOKEN ENDPOINT AUTH METHOD",
	}
}

func (c outputOAuth2ClientCollection) Table() [][]string {
	rows := make([][]string, len(c))
	for i, cl := range c {
		rows[i] = []string{
			cl.ClientID,
			cl.ClientName,
			cmdx.None,
			cl.Scope,
			cmdx.None,
			cmdx.None,
			cl.TokenEndpointAuthMethod,
		}

		if len(cl.ResponseTypes) > 0 {
			rows[i][2] = cl.ResponseTypes[0]
		}

		if len(cl.RedirectUris) > 0 {
			rows[i][4] = cl.RedirectUris[0]
		}

		if len(cl.GrantTypes) > 0 {
			rows[i][5] = cl.GrantTypes[0]
		}
	}

	return rows
}

func (c outputOAuth2ClientCollection) Interface() interface{} {
	return c
}

func (c outputOAuth2ClientCollection) Len() int {
	return len(c)
}
